<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.3.1">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Antonio Bianchi">

  
  
  
    
  
  <meta name="description" content=" ">

  
  <link rel="alternate" hreflang="en-us" href="/posts/ctf-ictf2013-mathconsole/">

  


  

  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    

    

  

  
  
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Montserrat:400,500|Roboto:400,400italic,500|Roboto+Mono">
  

  
  
  
  <link rel="stylesheet" href="/css/academic.min.2b48dc63649442c3c34ad57d2e5f031b.css">

  

  
  
  

  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="/posts/ctf-ictf2013-mathconsole/">

  
  
  
  
    
    
  
  <meta property="twitter:card" content="summary">
  
  <meta property="og:site_name" content="Antonio Bianchi">
  <meta property="og:url" content="/posts/ctf-ictf2013-mathconsole/">
  <meta property="og:title" content="iCTF 2013: mathconsole | Antonio Bianchi">
  <meta property="og:description" content=" "><meta property="og:image" content="img/icon-192.png">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2013-12-10T00:00:00&#43;00:00">
  
  <meta property="article:modified_time" content="2013-12-10T00:00:00&#43;00:00">
  

  

  

  <title>iCTF 2013: mathconsole | Antonio Bianchi</title>

</head>
<body id="top" data-spy="scroll" data-target="#TableOfContents" data-offset="71" >
  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" role="textbox" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/">Antonio Bianchi</a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav mr-auto">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about">
            
            <span>Home</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/teaching/">
            
            <span>Teaching</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link  active" href="/posts/">
            
            <span>Posts</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/publications/">
            
            <span>Publications</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/files/cv.pdf">
            
            <span>CV</span>
            
          </a>
        </li>

        
        

      
      </ul>
      <ul class="navbar-nav ml-auto">
      

        

        
        <li class="nav-item">
          <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        

        
        <li class="nav-item">
          <a class="nav-link js-dark-toggle" href="#"><i class="fas fa-moon" aria-hidden="true"></i></a>
        </li>
        

      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1 itemprop="name">iCTF 2013: mathconsole</h1>

  

  
    



<meta content="2013-12-10 00:00:00 &#43;0000 UTC" itemprop="datePublished">
<meta content="2013-12-10 00:00:00 &#43;0000 UTC" itemprop="dateModified">

<div class="article-metadata">

  
  
  
  
  <div>
    



  <span itemprop="author name" itemtype="http://schema.org/Person"><a href="/authors/admin/">Antonio Bianchi</a></span>

  </div>
  
  

  
  <span class="article-date">
    
    
      
    
    <time>Dec 10, 2013</time>
  </span>
  

  

  

  
  

  
  

  
    

  

</div>

    














  
</div>



  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      


<h3 id="mathconsole-ictf-2013-writeup">mathconsole (iCTF 2013): writeup </h3>
<p>For the <a href="http://ictf.cs.ucsb.edu/"><em>iCTF</em></a> 2013 competition, I developed the service called mathconsole. This writeup will be a a little bit different than usual: I will try not only to explain how to exploit this service, but also to justify some design choices I made while developing it. Additionally, I will also give some insights about how teams have exploited and patched this service.<br />
<br />
iCTF is a CTF competition organized by <a href="http://ucsb.edu/"><em>UCSB</em></a>, its rules are different than usual CTF and tend to change from year to year. You can read the description of the 2013 edition rules <a href="https://lists.cs.ucsb.edu/pipermail/ctf-participants/20131204/000499.html"><em>here</em></a>. My main goal for this service was to implement a server with two well-known vulnerabilities found in the gaming consoles Wii and Playstation 3. As far as I know, both vulnerabilities have been discovered by team Twiizers/fail0verflow <em>[1][2][3][4]</em>.</p>
<p>The first vulnerability (found in the Wii console) is caused by wrongly checking a RSA signature, the second (found in the Playstation 3) is caused by using a non-random nonce in the generation of an ECDSA signature. I will explain these vulnerabilities in detail later in this writeup. Unfortunately, nobody exploited the second vulnerability (about the ECDSA signature), probably because the other one was easier and, given the structure of the competition, it was not really worthing to exploit it. If you are not interested in this vulnerability, you can skip sections &quot;Authorization level bug&quot; and &quot;ECDSA vulnerability&quot;.<br />
<br />
<a href="media/mathconsole_blog.zip"><em>This zip file</em></a> contains the source code of the service, the scripts used to generate benign traffic, the .deb package installed on teams' machines, and all the other files I will refer during this writeup (forgive me for the &quot;not exactly clean&quot; code).</p>
<h2 id="overview">Overview</h2>
<p>This service has been written in Python 2.7 and it is implemented as a classical forking server. For the networking part, I mainly reused the code I wrote for the service PowerPlan that I wrote for the previous iCTF (you can read a very good writeup <a href="http://www.rogdham.net/2013/03/23/ictf-powerplan-write-up.en"><em>here</em></a> about it). The service is listening on port 9898; when you connect to it you get the following message:</p>
<p>Welcome to the most powerful backdoor-free calculator<br />
You can use it to safely perform your calculations about Nuclear reactions and trajectories of missiles<br />
A new on-the-cloud hacker-proof file storage functionality has been just added<br />
available commands:<br />
sum|&lt;n1&gt;|&lt;n2&gt; required authorization: L1 or L2<br />
multiply|&lt;n1&gt;|&lt;n2&gt; required authorization: L1<br />
mod|&lt;n1&gt;|&lt;n2&gt; required authorization: L1 or L2<br />
power|&lt;n1&gt;|&lt;n2&gt; required authorization: L3<br />
write|&lt;fname&gt;|&lt;b64 content&gt; required authorization: L2<br />
read_encrypted1|&lt;fname&gt;|&lt;key&gt; required authorization: L2<br />
read_encrypted2|&lt;fname&gt;|&lt;key&gt; required authorization: L2<br />
read_protected|&lt;fname&gt;|&lt;password&gt; required authorization: L1 + password<br />
what do you want to do?</p>
<p>When a command is inserted (in the format &lt;command&gt;|&lt;p1&gt;|&lt;p2&gt;) a signature is asked. Different commands require different authorizations that a user can get by providing a (base64 encoded) 256-byte long signature. We will see how a valid L1 signature can be trivially forged, and that both the verifications of L2 and L3 signatures contain fundamental problems that can be exploited. When a correct signature is provided, the specified command will be executed.<br />
<br />
The commands <em>sum</em>, <em>multiply</em>, <em>mod</em>, and <em>power</em> just perform the corresponding mathematical operations and return the result to the user. <em>write</em> allows the user to write a file in the folder <em>service_files</em> (we used this command to set the flags in teams' machines). <em>read_protected</em> returns the content of a file in the <em>service_files</em> folder but it requires a password. Specifically, it checks that the provided password matches with the first line of the content of the file that has been requested. We used this command to check that the flags we stored in the teams' machines were not deleted.<br />
<br />
Finally, <em>read_encrypted1</em> and <em>read_encrypted2</em> read and return the content of a file in the folder <em>service_files</em>, however they need the correct authentication. In theory, it would not be possible to execute them without having the correct RSA and ECDSA private keys (you can find both private keys in file private_keys.txt). In practice, the vulnerabilities of this service allow an attacker to skip almost entirely the verification of the RSA signature and to recover the private ECDSA signature.<br />
<br />
In this service, flags were written by us using the command <em>write</em>. Specifically, the first line was a random password protecting a file (which value was only known by us), whereas the second line was the flag. The name of the file was the <em>flag_id</em>. Attackers had to write exploits that were able to steal the <em>flag</em> corresponding to the provided <em>flag_id</em>.  To do so, the only possibility was to use the commands <em>read_encrypted1</em> or <em>read_encrypted2</em>. Replay attacks were not possible since the requested <em>flag_id</em> (and so the command that an attacker needed to sign) were random and always different.</p>
<h2 id="anti-decompilation">Anti-decompilation</h2>
<p>I tried to make this service a little bit tricky to be decompiled. From my experience, <a href="https://github.com/wibiti/uncompyle2"><em>uncopyle2</em></a> is usually able to recover &quot;almost perfectly&quot; the original Python code, given the compiled .pyc file. My goal was to create a .pyc file that was perfectly working when executed by the Python interpreter, but that made the decompilation process to fail.<br />
<br />
By randomly fuzzing a .pyc file and looking a little bit in the Python bytecode specification I realized that:</p>
<ul>
<li><blockquote>
<p>a division operation (like this: a = 0/0) is compiled to the following 10-byte sequence: 15 5A 12 00 64 04 00 64 04 00</p>
</blockquote></li>
<li><blockquote>
<p>changing the second byte from 0x5A to 0x00 makes uncompyle2 to fail with the following error:<br />
[...]<br />
194    LOAD_CONST        0<br />
197    LOAD_CONST        0<br />
200    BINARY_DIVIDE     None<br />
201    STOP_CODE         None<br />
202    &lt;18&gt;              None<br />
203    STOP_CODE         None<br />
<br />
204    LOAD_CONST        0<br />
207    LOAD_CONST        0<br />
210    BINARY_DIVIDE     None<br />
211    STORE_NAME        'a'<br />
<br />
214    LOAD_CONST        0<br />
217    LOAD_CONST        0<br />
220    BINARY_DIVIDE     None<br />
221    STORE_NAME        'a'<br />
[...]<br />
Syntax error at or near `STOP_CODE' token at offset 201</p>
</blockquote></li>
</ul>
<p>So, I inserted in my code (at the &quot;top-level&quot; of the game_server.py file) the following code (that obviously is never executed):</p>
<p>#uncompyle trick<br />
fff=False<br />
if(fff):<br />
    a = 0/0<br />
    a = 0/0<br />
    a = 0/0<br />
    a = 0/0<br />
    a = 0/0<br />
    a = 0/0<br />
    a = 0/0<br />
    a = 0/0<br />
    a = 0/0<br />
    a = 0/0<br />
    a = 0/0<br />
    a = 0/0<br />
    a = 0/0<br />
    a = 0/0<br />
    a = 0/0</p>
<p>compile.py compiles game_server.py in game_server.pyc (using the &quot;standard&quot; Python mechanism), then it looks for the byte sequence corresponding to the 15 division instructions I showed before. When it finds this sequence, it patches the second byte of the first division instruction from 0x5A to 0x00. This makes uncompyle2 unable to decompile the .pyc file correctly.<br />
<br />
The easiest way to fix this is to change the byte at 0xE7 from 0x00 to 0x5A in the file game_server.pyc. After this this modification, uncompyle2 is able to recover the original source code.</p>
<h2 id="signatures-and-authorization-levels">Signatures and authorization levels</h2>
<p>Before executing a command, the service checks if the provided signature grants the authorization level required to execute it. For instance, to execute the command <em>multiply</em> users have to provide a L1 signature, to execute the command <em>power</em> a L3 signature is necessary, and to execute the command <em>sum</em> they can provide either a L1 or a L2 signature. Every signature is 256-byte long, before sending it to the server, it needs to be base64-encoded.<br />
<br />
I will now explain how L1, L2, and L3 signature are legitimately created by scripts generating benign traffic (see benign1.py, benign2.py, benign3.py, benign4.py). In this context, <em>command</em> is the full string of the requested command, for instance: &quot;mod|23|5&quot;:</p>
<ul>
<li><blockquote>
<p><em>L1</em>: a sha1 hash of the sent command:<br />
hash = self.sha1(command)<br />
cert = &quot;X&quot;*(256-len(hash)) + hash<br />
Of course, this can be trivially forged by anyone.</p>
</blockquote></li>
<li><blockquote>
<p><em>L2</em>: a RSA signature of the sent command:<br />
 signer = PKCS1_v1_5.new(private_key_rsa)<br />
 digest = SHA.new()<br />
 digest.update(command)<br />
 cert = signer.sign(digest)<br />
To compute it, I use a (secret) private key and the PyCrypto library. See the file benign1.py for the complete source code.</p>
</blockquote></li>
<li><blockquote>
<p><em>L3</em>: an ECDSA signature of the sent command:<br />
cert_key = private_key_ec.sign_digest(hash,k=4)<br />
cert = &quot;X&quot;*(256-len(cert_key)) + cert_key<br />
To compute it, I use a (secret) private key and the Python ecdsa library (install it by using <em>pip install ecdsa</em>). See the file benign2.py for the complete source code.</p>
</blockquote></li>
</ul>
<h2 id="authorization-level-bug">Authorization level bug</h2>
<p>The code managing this authorization-checking functionality is contained in functions <em>init_access</em> and <em>check_security_level</em>. I implemented this in a deliberately over-complicated way, to be able to hide a subtle bug. My goal was to allow the command <em>read_encrypted2</em> to be used providing a L3 signature (even if in the textual description of the commands it is written that <em>read_encrypted2</em> needs a L2 signature). This will be relevant for the full exploitation of the ECDSA vulnerability, if you are not interested in it, you can just skip this section.<br />
<br />
I will now explain the permission checking in terms of mathematical operations, the actual implementation is slightly different. A function <em>indexOf()</em> is defined, such that, given a tuple <em>p</em> = &lt;command, permission&gt;, it returns an index between 1 and 24. For instance: <em>indexOf(&lt;sum, L3&gt;)</em> = 3 and <em>indexOf(&lt;multiply, L1&gt;)</em> = 4. The variable <em>access_summary</em> is computed with the following formula:</p>
<p><span id="MathJax-Element-1-Frame" class="anchor"><span id="MathJax-Span-1" class="anchor"><span id="MathJax-Span-2" class="anchor"><span id="MathJax-Span-3" class="anchor"></span></span></span></span><em>a</em><span id="MathJax-Span-4" class="anchor"></span><em>c</em><span id="MathJax-Span-5" class="anchor"></span><em>c</em><span id="MathJax-Span-6" class="anchor"></span><em>e</em><span id="MathJax-Span-7" class="anchor"></span><em>s</em><span id="MathJax-Span-8" class="anchor"></span><em>s</em><span id="MathJax-Span-9" class="anchor"></span>_<span id="MathJax-Span-10" class="anchor"></span><em>s</em><span id="MathJax-Span-11" class="anchor"></span><em>u</em><span id="MathJax-Span-12" class="anchor"></span><em>m</em><span id="MathJax-Span-13" class="anchor"></span><em>m</em><span id="MathJax-Span-14" class="anchor"></span><em>a</em><span id="MathJax-Span-15" class="anchor"></span><em>r</em><span id="MathJax-Span-16" class="anchor"></span><em>y</em><span id="MathJax-Span-17" class="anchor"></span>=<span id="MathJax-Span-18" class="anchor"><span id="MathJax-Span-19" class="anchor"></span></span>∏<span id="MathJax-Span-20" class="anchor"><span id="MathJax-Span-21" class="anchor"><span id="MathJax-Span-22" class="anchor"></span></span></span><em>p</em><span id="MathJax-Span-23" class="anchor"><span id="MathJax-Span-24" class="anchor"><span id="MathJax-Span-25" class="anchor"></span></span></span><em>P</em><span id="MathJax-Span-26" class="anchor"><span id="MathJax-Span-27" class="anchor"><span id="MathJax-Span-28" class="anchor"></span></span></span>(<span id="MathJax-Span-29" class="anchor"></span>(<span id="MathJax-Span-30" class="anchor"></span><em>p</em><span id="MathJax-Span-31" class="anchor"></span><em>r</em><span id="MathJax-Span-32" class="anchor"></span><em>i</em><span id="MathJax-Span-33" class="anchor"></span><em>m</em><span id="MathJax-Span-34" class="anchor"></span><em>e</em><span id="MathJax-Span-35" class="anchor"></span><em>s</em><span id="MathJax-Span-36" class="anchor"></span>[<span id="MathJax-Span-37" class="anchor"></span><em>i</em><span id="MathJax-Span-38" class="anchor"></span><em>n</em><span id="MathJax-Span-39" class="anchor"></span><em>d</em><span id="MathJax-Span-40" class="anchor"></span><em>e</em><span id="MathJax-Span-41" class="anchor"></span><em>x</em><span id="MathJax-Span-42" class="anchor"></span><em>O</em><span id="MathJax-Span-43" class="anchor"></span><em>f</em><span id="MathJax-Span-44" class="anchor"></span>(<span id="MathJax-Span-45" class="anchor"></span><em>p</em><span id="MathJax-Span-46" class="anchor"></span>)<span id="MathJax-Span-47" class="anchor"></span>]<span id="MathJax-Span-48" class="anchor"><span id="MathJax-Span-49" class="anchor"></span></span>)<span id="MathJax-Span-50" class="anchor"></span>2<span id="MathJax-Span-51" class="anchor"></span>)</p>
<p>Where <em>primes</em> is a sorted list of all the prime numbers up to 97 and <em>P</em> is a list of tuples &lt;command, permission&gt; as specified in the textual description of each command. For instance:</p>
<p><span id="MathJax-Element-2-Frame" class="anchor"><span id="MathJax-Span-52" class="anchor"><span id="MathJax-Span-53" class="anchor"><span id="MathJax-Span-54" class="anchor"></span></span></span></span>&lt;<span id="MathJax-Span-55" class="anchor"></span><em>s</em><span id="MathJax-Span-56" class="anchor"></span><em>u</em><span id="MathJax-Span-57" class="anchor"></span><em>m</em><span id="MathJax-Span-58" class="anchor"></span>,<span id="MathJax-Span-59" class="anchor"></span><em>L</em><span id="MathJax-Span-60" class="anchor"></span>1<span id="MathJax-Span-61" class="anchor"></span>&gt;∈<span id="MathJax-Span-62" class="anchor"></span><em>P</em><span id="MathJax-Span-63" class="anchor"></span>,<span id="MathJax-Span-64" class="anchor"></span><em>b</em><span id="MathJax-Span-65" class="anchor"></span><em>u</em><span id="MathJax-Span-66" class="anchor"></span><em>t</em><span id="MathJax-Span-67" class="anchor"></span>&lt;<span id="MathJax-Span-68" class="anchor"></span><em>p</em><span id="MathJax-Span-69" class="anchor"></span><em>o</em><span id="MathJax-Span-70" class="anchor"></span><em>w</em><span id="MathJax-Span-71" class="anchor"></span><em>e</em><span id="MathJax-Span-72" class="anchor"></span><em>r</em><span id="MathJax-Span-73" class="anchor"></span>,<span id="MathJax-Span-74" class="anchor"></span><em>L</em><span id="MathJax-Span-75" class="anchor"></span>2<span id="MathJax-Span-76" class="anchor"></span>&gt;∉<span id="MathJax-Span-77" class="anchor"></span><em>P</em></p>
<p>To check if a given command C, can be accessed by a signature of level L, it is checked if:</p>
<p><span id="MathJax-Element-3-Frame" class="anchor"><span id="MathJax-Span-78" class="anchor"><span id="MathJax-Span-79" class="anchor"><span id="MathJax-Span-80" class="anchor"></span></span></span></span>(<span id="MathJax-Span-81" class="anchor"></span><em>a</em><span id="MathJax-Span-82" class="anchor"></span><em>c</em><span id="MathJax-Span-83" class="anchor"></span><em>c</em><span id="MathJax-Span-84" class="anchor"></span><em>e</em><span id="MathJax-Span-85" class="anchor"></span><em>s</em><span id="MathJax-Span-86" class="anchor"></span><em>s</em><span id="MathJax-Span-87" class="anchor"></span>_<span id="MathJax-Span-88" class="anchor"></span><em>s</em><span id="MathJax-Span-89" class="anchor"></span><em>u</em><span id="MathJax-Span-90" class="anchor"></span><em>m</em><span id="MathJax-Span-91" class="anchor"></span><em>m</em><span id="MathJax-Span-92" class="anchor"></span><em>a</em><span id="MathJax-Span-93" class="anchor"></span><em>r</em><span id="MathJax-Span-94" class="anchor"></span><em>y</em><span id="MathJax-Span-95" class="anchor"></span>%<span id="MathJax-Span-96" class="anchor"></span><em>p</em><span id="MathJax-Span-97" class="anchor"></span><em>r</em><span id="MathJax-Span-98" class="anchor"></span><em>i</em><span id="MathJax-Span-99" class="anchor"></span><em>m</em><span id="MathJax-Span-100" class="anchor"></span><em>e</em><span id="MathJax-Span-101" class="anchor"></span><em>s</em><span id="MathJax-Span-102" class="anchor"></span>[<span id="MathJax-Span-103" class="anchor"></span><em>i</em><span id="MathJax-Span-104" class="anchor"></span><em>n</em><span id="MathJax-Span-105" class="anchor"></span><em>d</em><span id="MathJax-Span-106" class="anchor"></span><em>e</em><span id="MathJax-Span-107" class="anchor"></span><em>f</em><span id="MathJax-Span-108" class="anchor"></span><em>O</em><span id="MathJax-Span-109" class="anchor"></span><em>f</em><span id="MathJax-Span-110" class="anchor"></span>(<span id="MathJax-Span-111" class="anchor"></span><em>C</em><span id="MathJax-Span-112" class="anchor"></span>,<span id="MathJax-Span-113" class="anchor"></span><em>L</em><span id="MathJax-Span-114" class="anchor"></span>)<span id="MathJax-Span-115" class="anchor"></span>]<span id="MathJax-Span-116" class="anchor"></span>)<span id="MathJax-Span-117" class="anchor"></span>==<span id="MathJax-Span-118" class="anchor"></span>0</p>
<p>If true, then the command C can be executed by providing a signature of level L, otherwise it cannot.<br />
<br />
<em>indexOf</em>(&lt;<em>read_encrypted2</em>, <em>L3</em>&gt;) = 21. The list of primes has been deliberately set incorrectly, so that primes[21] = 75 (instead of 79). Since <em>access_summary</em> contains twice the factor 5 (corresponding to the tuple &lt;<em>sum</em>, <em>L2</em>&gt;) and 3 (corresponding to the tuple &lt;<em>sum</em>, <em>L1</em>&gt;), <em>access_summary</em> is divisible by 75 and so the command <em>read_encrypted2</em> can be used by providing a L3 signature, differently from the textual specification.</p>
<h2 id="rsa-vulnerability">RSA vulnerability</h2>
<p>As I said, in implementing the RSA vulnerability I tried to mimic the one found in the Wii console <em>[2]</em>. For a general overview of how RSA can be used to sign a message look here <em>[5]</em>. In theory, to produce a valid L2 signature (that can be used to read the flags by invoking the command <em>read_encrypted1</em> or <em>read_encrypted2</em>), it is necessary to have the original private key. However, there is a fundamental bug in how the signature it is checked:</p>
<p>def verify_with_pubkey_rsa(self,public_key_rsa,local_hash,certificate):<br />
    m = public_key_rsa.encrypt(certificate,None)[0]<br />
    m = &quot;\x00&quot;*(256-len(m)) + m<br />
    remote_hash = m[-20:] #the padding is not checked<br />
    libc = ctypes.CDLL(&quot;libc.so.6&quot;)<br />
    if(libc.strncmp(local_hash,remote_hash,20)==0):#strncmp is REALLY bad here<br />
        return True<br />
    else:<br />
        return False</p>
<p>As you can see <em>strncmp</em> is used, instead of <em>memcmp</em> (I used <em>ctypes</em> to directly invoke the <em>libc</em> implementation of <em>strncmp</em>). <em>strncmp</em> returns 0 and stops the comparison between the signed hash and the computed one as soon as 0x00 bytes are encountered in the same position in both strings. In addition, the padding of the original (20-byte long) message is not checked.<br />
<br />
The easiest way to exploit this is to provide a signature of all 0x00 bytes: given the mathematical properties of RSA, this makes m = &quot;\x00&quot; * 256. At this point it is just necessary to provide a command whose sha1 hash starts with 0x00. It is possible to bruteforce it by changing the value &lt;key&gt; of the command <em>read_encrypted1</em> or <em>read_encrypted2</em> (&lt;key&gt; cannot be bigger than 4000, however, as we will see, we do not actually need so many tries).<br />
<br />
Assuming that the sha1 function returns values with a random distribution, the probability of randomly find such a hash in N tries is:</p>
<p><span id="MathJax-Element-4-Frame" class="anchor"><span id="MathJax-Span-119" class="anchor"><span id="MathJax-Span-120" class="anchor"><span id="MathJax-Span-121" class="anchor"></span></span></span></span>1<span id="MathJax-Span-122" class="anchor"></span>−<span id="MathJax-Span-123" class="anchor"></span>(<span id="MathJax-Span-124" class="anchor"></span>255<span id="MathJax-Span-125" class="anchor"><span id="MathJax-Span-126" class="anchor"><span id="MathJax-Span-127" class="anchor"></span></span></span>/<span id="MathJax-Span-128" class="anchor"></span>256<span id="MathJax-Span-129" class="anchor"><span id="MathJax-Span-130" class="anchor"></span></span>)<span id="MathJax-Span-131" class="anchor"></span><em>N</em></p>
<p>For instance, trying as &lt;key&gt; all the numbers between 0 and 2000, the probability of finding a command whose hash starts with 0x00 is more that 99.9%. So, a value of &lt;key&gt; generating a hash with the wanted property can be found in a negligible amount of time. This attack is implemented in exploit.py.<br />
<br />
It is important to notice that, even if the checking of the padding had been implemented correctly, it would have been still possible to forge a signature. Refer to <em>[2]</em> for further details.<br />
<br />
An easy patch to this vulnerability is to change <em>strncmp</em> to <em>memcmp</em> (or use the == Python operator). Alternatively, it is possible to directly use the <em>verify</em> function provided by PyCrypto (that also checks the validity of the padding).<br />
<br />
To have a complete and working exploit, it is also necessary to revert the manipulation that the service does to the content of the file read before sending it to the client. In fact, the commands <em>read_encrypted1</em> use (&lt;key&gt; % 256) as a xor-key, whereas <em>read_encrypted2</em> works similarly, but it rotates right the value (&lt;key&gt; % 256) before xoring it to a new character. Both operations can be trivially reverted (knowing the value of &lt;key&gt;).</p>
<h2 id="ecdsa-vulnerability">ECDSA vulnerability</h2>
<p>The code generating the ECDSA signature (see benign2.py):</p>
<p>cert_key = private_key_ec.sign_digest(hash,k=4)</p>
<p>uses a fixed value for <em>k</em>. This is a well-known implementation problem that can be exploited to recover the private_key. See <em>[4]</em> (or <em>[3]</em> at minute 35:30)  for the mathematical explanation.<br />
<br />
To do so, it is necessary to obtain two tuples &lt;message1, signature1&gt;, &lt;message2, signature2&gt;.  This can be done by recording the signatures used when the command <em>power</em> (that requires a L3 signature) is invoked (benign2.py invokes such a command). The service nicely prints these values on standard output. The script recover_ecdsa_key.py recovers the private key in this way.<br />
<br />
The code performing the mathematical operations is the following:</p>
<p>#using the same variable names as in: http://en.wikipedia.org/wiki/Elliptic_Curve_DSA<br />
n = curve_order<br />
s1 = string_to_number(sig1[-24:])<br />
s2 = string_to_number(sig2[-24:])<br />
r = string_to_number(sig1[-48:-24])<br />
<br />
z1 = string_to_number(sha1(c1))<br />
z2 = string_to_number(sha1(c2))<br />
<br />
sdiff_inv = inverse_mod(((s1-s2)%n),n)<br />
k = ( ((z1-z2)%n) * sdiff_inv) %n<br />
r_inv = inverse_mod(r,n)<br />
da = (((((s1*k) %n) -z1) %n) * r_inv) % n<br />
<br />
recovered_private_key_ec = SigningKey.from_secret_exponent(da)</p>
<p>Refer to the file recover_ecdsa_key.py for the full implementation.<br />
<br />
After the recovery of the private key it is possible to use it to generate a valid L3 signature that, due to the bug explained in the section &quot;Authorization level bug&quot;, can be used to invoke the command <em>read_encrypted2</em>.<br />
<br />
Once the private key has been recovered, an attacker can produce traffic indistinguishable from the &quot;benign&quot; one. In fact, in this case, the vulnerability is not in the service, but it is in how the client (that I wrote to generate &quot;benign&quot; traffic) use the (secret) private ECDSA signature.<br />
<br />
The generated benign traffic never targets the <em>read_encrypted2</em> using a L3 signature both because this is against the textual description of the permissions and because, otherwise, it would have been impossible for teams to distinguish between benign and malicious traffic.<br />
<br />
For this reason, an easy patch is to change the value 75 in the list of primes to 79, making the command <em>read_encrypted2</em> inaccessible by using a L3 signature (see section &quot;Authorization level bug&quot;).</p>
<h2 id="what-happened-during-the-ictf">What happened during the iCTF </h2>
<p>Unfortunately nobody exploited the ECDSA vulnerability, even if two hours before the ending of the competition I gave this hint:</p>
<p>HINT: <a href="http://xkcd.com/221"><em>http://xkcd.com/221</em></a>/ (and 75 is not prime!)</p>
<p>35 exploits were submitted, out of which 18 were working. 12 working exploits were just a copy of the exploit for the RSA vulnerability I developed (teams could buy exploits from us). Interestingly, one team obfuscated the source code of its attack. This was pointless, in fact, teams could not see the source code of attacks developed by other teams.<br />
<br />
Some teams submitted exploits generating a signature different than &quot;\x00&quot; * 256. Specifically, some signatures with the following property were generated:</p>
<p><span id="MathJax-Element-5-Frame" class="anchor"><span id="MathJax-Span-132" class="anchor"><span id="MathJax-Span-133" class="anchor"><span id="MathJax-Span-134" class="anchor"></span></span></span></span><em>r</em><span id="MathJax-Span-135" class="anchor"></span><em>s</em><span id="MathJax-Span-136" class="anchor"></span><em>a</em><span id="MathJax-Span-137" class="anchor"></span>_<span id="MathJax-Span-138" class="anchor"></span><em>p</em><span id="MathJax-Span-139" class="anchor"></span><em>u</em><span id="MathJax-Span-140" class="anchor"></span><em>b</em><span id="MathJax-Span-141" class="anchor"></span><em>l</em><span id="MathJax-Span-142" class="anchor"></span><em>i</em><span id="MathJax-Span-143" class="anchor"></span><em>c</em><span id="MathJax-Span-144" class="anchor"></span>_<span id="MathJax-Span-145" class="anchor"></span><em>k</em><span id="MathJax-Span-146" class="anchor"></span><em>e</em><span id="MathJax-Span-147" class="anchor"></span><em>y</em><span id="MathJax-Span-148" class="anchor"></span>.<span id="MathJax-Span-149" class="anchor"></span><em>e</em><span id="MathJax-Span-150" class="anchor"></span><em>n</em><span id="MathJax-Span-151" class="anchor"></span><em>c</em><span id="MathJax-Span-152" class="anchor"></span><em>r</em><span id="MathJax-Span-153" class="anchor"></span><em>y</em><span id="MathJax-Span-154" class="anchor"></span><em>p</em><span id="MathJax-Span-155" class="anchor"></span><em>t</em><span id="MathJax-Span-156" class="anchor"></span>(<span id="MathJax-Span-157" class="anchor"></span>(<span id="MathJax-Span-158" class="anchor"></span><em>b</em><span id="MathJax-Span-159" class="anchor"></span>64<span id="MathJax-Span-160" class="anchor"></span><em>d</em><span id="MathJax-Span-161" class="anchor"></span><em>e</em><span id="MathJax-Span-162" class="anchor"></span><em>c</em><span id="MathJax-Span-163" class="anchor"></span><em>o</em><span id="MathJax-Span-164" class="anchor"></span><em>d</em><span id="MathJax-Span-165" class="anchor"></span><em>e</em><span id="MathJax-Span-166" class="anchor"></span>(<span id="MathJax-Span-167" class="anchor"></span><em>s</em><span id="MathJax-Span-168" class="anchor"></span><em>i</em><span id="MathJax-Span-169" class="anchor"></span><em>g</em><span id="MathJax-Span-170" class="anchor"></span><em>n</em><span id="MathJax-Span-171" class="anchor"></span><em>a</em><span id="MathJax-Span-172" class="anchor"></span><em>t</em><span id="MathJax-Span-173" class="anchor"></span><em>u</em><span id="MathJax-Span-174" class="anchor"></span><em>r</em><span id="MathJax-Span-175" class="anchor"></span><em>e</em><span id="MathJax-Span-176" class="anchor"></span>)<span id="MathJax-Span-177" class="anchor"></span>)<span id="MathJax-Span-178" class="anchor"></span>)<span id="MathJax-Span-179" class="anchor"></span>[<span id="MathJax-Span-180" class="anchor"></span>−<span id="MathJax-Span-181" class="anchor"></span>20<span id="MathJax-Span-182" class="anchor"></span>]<span id="MathJax-Span-183" class="anchor"></span>==<span id="MathJax-Span-184" class="anchor"></span>0<span id="MathJax-Span-185" class="anchor"></span><em>x</em><span id="MathJax-Span-186" class="anchor"></span>00</p>
<p>Given the bug in the hash comparison, such signatures were still considered as valid if the hash of the submitted command was starting with a 0x00 byte.<br />
<br />
The first working exploit was submitted by PPP (congratulations!).<br />
<br />
I did not dig into all the teams' machines, but from a quick look I have seen some teams patching the service by changing the <em>strncmp</em> instruction either with the standard &quot;==&quot; Python operator or the <em>memcmp</em> libc function.</p>
<h2 id="references">References</h2>
<p>[1] <a href="http://hackmii.com/2008/04/keys-keys-keys"><em>http://hackmii.com/2008/04/keys-keys-keys</em></a><br />
[2] <a href="http://wiibrew.org/wiki/Signing_bug"><em>http://wiibrew.org/wiki/Signing_bug</em></a><br />
[3] <a href="https://www.youtube.com/watch?v=PR9tFXz4Quc"><em>http://www.youtube.com/watch?v=PR9tFXz4Quc</em></a><br />
[4] <a href="http://en.wikipedia.org/wiki/Elliptic_Curve_DSA"><em>http://en.wikipedia.org/wiki/Elliptic_Curve_DSA</em></a><br />
[5] <a href="http://en.wikipedia.org/wiki/RSA_(algorithm)"><em>http://en.wikipedia.org/wiki/RSA_%28algorithm%29</em></a> </p>



    </div>

    

<div class="article-tags">
  
  <a class="badge badge-light" href="/tags/ctf/">CTF</a>
  
</div>



    
      








  
  
    
  
  





  
  <div class="media author-card" itemscope itemtype="http://schema.org/Person">
    
      
      <img class="portrait mr-3" src="/authors/admin/avatar_hub703259d6dc6f66958479a17d975ab61_1965031_250x250_fill_lanczos_center_3.png" itemprop="image" alt="Avatar">
    

    <div class="media-body">
      <h5 class="card-title" itemprop="name"><a href="/authors/admin/">Antonio Bianchi</a></h5>
      <h6 class="card-subtitle">Associate Professor</h6>
      
      <ul class="network-icon" aria-hidden="true">
        
          
          
          
            
          
          
          
          
          
          <li>
            <a itemprop="sameAs" href="mailto:antoniob@purdue.edu" >
              <i class="fas fa-envelope"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://twitter.com/anton00b" target="_blank" rel="noopener">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
        
          
          
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://scholar.google.com/citations?user=RMm4j1AAAAAJ&amp;hl=en" target="_blank" rel="noopener">
              <i class="ai ai-google-scholar"></i>
            </a>
          </li>
        
          
          
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="/files/cv.pdf" >
              <i class="ai ai-cv"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>



      
      
    

    

    


  </div>
</article>

<div class="container">
  <footer class="site-footer">
  

  <p class="powered-by">
    

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

</div>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous"></script>
        
      

      
      
    

    
    

    
    
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script>
      const search_index_filename = "/index.json";
      const i18n = {
        'placeholder': "Search...",
        'results': "results found",
        'no_results': "No results found"
      };
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.eeb855c70a08cf40f8f8d58c82fa7d5e.js"></script>

  </body>
</html>

