<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.3.1">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Antonio Bianchi">

  
  
  
    
  
  <meta name="description" content=" ">

  
  <link rel="alternate" hreflang="en-us" href="/posts/ctf-defconquals2011-bin400/">

  


  

  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    

    

  

  
  
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Montserrat:400,500|Roboto:400,400italic,500|Roboto+Mono">
  

  
  
  
  <link rel="stylesheet" href="/css/academic.min.2b48dc63649442c3c34ad57d2e5f031b.css">

  

  
  
  

  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="/posts/ctf-defconquals2011-bin400/">

  
  
  
  
    
    
  
  <meta property="twitter:card" content="summary">
  
  <meta property="og:site_name" content="Antonio Bianchi">
  <meta property="og:url" content="/posts/ctf-defconquals2011-bin400/">
  <meta property="og:title" content="Defcon Quals 2011: binary l33tness 400 | Antonio Bianchi">
  <meta property="og:description" content=" "><meta property="og:image" content="img/icon-192.png">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2011-08-01T00:00:00&#43;00:00">
  
  <meta property="article:modified_time" content="2011-08-01T00:00:00&#43;00:00">
  

  

  

  <title>Defcon Quals 2011: binary l33tness 400 | Antonio Bianchi</title>

</head>
<body id="top" data-spy="scroll" data-target="#TableOfContents" data-offset="71" >
  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" role="textbox" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/">Antonio Bianchi</a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav mr-auto">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about">
            
            <span>Home</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/teaching/">
            
            <span>Teaching</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link  active" href="/posts/">
            
            <span>Posts</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/publications/">
            
            <span>Publications</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/files/cv.pdf">
            
            <span>CV</span>
            
          </a>
        </li>

        
        

      
      </ul>
      <ul class="navbar-nav ml-auto">
      

        

        
        <li class="nav-item">
          <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        

        
        <li class="nav-item">
          <a class="nav-link js-dark-toggle" href="#"><i class="fas fa-moon" aria-hidden="true"></i></a>
        </li>
        

      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1 itemprop="name">Defcon Quals 2011: binary l33tness 400</h1>

  

  
    



<meta content="2011-08-01 00:00:00 &#43;0000 UTC" itemprop="datePublished">
<meta content="2011-08-01 00:00:00 &#43;0000 UTC" itemprop="dateModified">

<div class="article-metadata">

  
  
  
  
  <div>
    



  <span itemprop="author name" itemtype="http://schema.org/Person"><a href="/authors/admin/">Antonio Bianchi</a></span>

  </div>
  
  

  
  <span class="article-date">
    
    
      
    
    <time>Aug 1, 2011</time>
  </span>
  

  

  

  
  

  
  

  
    

  

</div>

    














  
</div>



  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      


<h3>Defcon 19 (2011) - BINARY L33tness 400 - Writeup </h3>

<p><strong>Preliminary analysis</strong></p>
<p>This is a Windows 32bit PE binary file. It shows the string &quot;hello world&quot; inside a shell and it exits.</p>
<table>
<tbody>
<tr class="odd">
<td align="left"><img src="media/image1.png" width="600" height="87" /></td>
</tr>
<tr class="even">
<td align="left">b400 output</td>
</tr>
</tbody>
</table>
<p>It is packed: PEiD reports: tElock 0.98b1 -&gt; tE!</p>
<p>If you open it with Ollydbg, it will say you that b400 executable is packed. This message can be quite annoying, if you wish you can patch Ollydbg itself to skip it :-)</p>
<p><strong>Configuring Ollydbg</strong></p>
<p>When you run it inside Ollydbg, a lot of different errors appear. You can ignore them all:</p>
<p>Debugging options --&gt; Exceptions --&gt; &quot;Ignore also the following exceptions or ranges&quot; --&gt; add 00000000-FFFFFFFF range. Set also: &quot;Ignore memory access violations in KERNEL32&quot; and unset all other options.</p>
<p>If you press F9 you will get a message &quot;Don't know how to bypass...&quot;, you can skip it by pressing Shift+F9.</p>
<p>Since this program is heavily packed (probably twice), it is useful to have a breakpoint inside VirtualAlloc API, in order to track memory region creations. You can put it here:</p>
<table>
<tbody>
<tr class="odd">
<td align="left"><img src="media/image2.png" width="600" height="100" /></td>
</tr>
<tr class="even">
<td align="left">When this breakpoint is hit, in EAX you can see the base address of the memory region allocated</td>
</tr>
</tbody>
</table>
<p>If you try to change b400 memory or to place a hardware breakpoint, you will get the following error message:</p>
<table>
<tbody>
<tr class="odd">
<td align="left"><img src="media/image3.png" width="500" height="90" /></td>
</tr>
<tr class="even">
<td align="left">A hardware breakpoint (or a memory modification) has been detected!</td>
</tr>
</tbody>
</table>
<p>This is not a big deal since this check is done only before the first call to VirtualAlloc API, just remember that, when you need to place a hardware breakpoint, you have to do it after that VirtualAlloc has been called at least one time.</p>
<p><strong>Finding original executable file</strong></p>
<p>You can try to find the original executable file in memory. Run the program, when it terminates you can still search inside its memory for the string &quot;hello world&quot;. You will find it in three different locations. The &quot;hello world&quot; string at 0x00415000 is the most interesting since it is located inside b400 memory. It is dinamically decrypted (in fact, when b400 is going to start, memory at 0x00415000 is filled with zeros).</p>
<p>You can understand when it is generated by placing a hardware breakpoint on write on 0x00415000 (Remember: hardware breakpoints can be set only after that VirtualAlloc has been called once).</p>
<p>This breakpoint is hit twice. The first time some zeros are written, the second time the &quot;hello world&quot; string is written from instruction at: 0x0042E1FB.</p>
<p>Single stepping at this location you can easily identify a decryption function. The code is extremely complex, however you only need to know that:</p>
<ul>
<li><blockquote>
<p>Most of the time data are copied from [ESI] to [EDI] one byte at a time.</p>
</blockquote></li>
<li><blockquote>
<p>Under &quot;some circumstances&quot; data written to [EDI] are retrieved in different ways</p>
</blockquote></li>
</ul>
<p>For instance, &quot;hello world&quot; is copied from &quot;he? world&quot; (where ?=0x11), 0x11 character is substituted with &quot;llo&quot; string copied from &quot;FlsAlloc&quot; string at 0x40D6EC :-)</p>
<p>If you wish, you can dump code from 0x0042E1F8 to 0x0042E2B1 and try to analyze it with IDA Pro, but this is not necessary at all.</p>
<table>
<tbody>
<tr class="odd">
<td align="left"><img src="media/image4.png" width="600" height="210" /></td>
</tr>
<tr class="even">
<td align="left">The decryption function</td>
</tr>
</tbody>
</table>
<p>It is useful to understand the range of data copied by this function. You can place a conditional log on 0x0042E1FB and log the value of EDI. You cannot place this breakpoint when the program starts, because the code of this decryption function is written during the execution of b400. So, place a hardware breakpoint on execution on 0x0042E1FB and when it is hit, place the conditional log on 0x0042E1FB.</p>
<p>What you will get is a log of memory locations written by the decryption function. It is not 100% complete because, as I said before, not all the data are copied with the MOV BYTE PTR DS:[EDI],AL instruction. However, you can see that this function writes memory from 0x00401000 to 0x0042DDCA.</p>
<p>You can change the conditional log settings, in order to make it stop the program execution when EDI==0x0042DDCA, in this way you can see that, when this function finishes, the following code is executed:</p>
<table>
<tbody>
<tr class="odd">
<td align="left"><img src="media/image5.png" width="600" height="324" /></td>
</tr>
<tr class="even">
<td align="left">Going to Original Entry Point...</td>
</tr>
</tbody>
</table>
<p>Then:</p>
<ul>
<li><blockquote>
<p>IAT is rebuild</p>
</blockquote></li>
<li><blockquote>
<p>Memory access is reset (this is an anti-unpacking technique)</p>
</blockquote></li>
<li><blockquote>
<p>The execution jumps to the Original Entry Point at 0x00401560</p>
</blockquote></li>
</ul>
<p>At 0x00401560 we have the OEP.</p>
<table>
<tbody>
<tr class="odd">
<td align="left"><img src="media/image6.png" width="600" height="243" /></td>
</tr>
<tr class="even">
<td align="left">The Original Entry Point</td>
</tr>
</tbody>
</table>
<p>If you wish, now you can dump the process (using LordPE) and fix the IAT (using ImpREC, OEP RVA=0x1560, IAT RVA=0xC000, IAT size=0xF7C). If you do so, you will get a valid PE file. (But it will crash, because some values are read from memory allocated by the packer, I don't know why... ).</p>
<p>Once you have a valid PE file, you can load it in IDA Pro. IDA will correctly understands that code at 0x00401000 is the real &quot;main&quot; of this program.</p>
<table>
<tbody>
<tr class="odd">
<td align="left"><img src="media/image7.png" width="600" height="210" /></td>
</tr>
<tr class="even">
<td align="left">IDA Pro analysis of the &quot;main&quot;</td>
</tr>
</tbody>
</table>
<p><strong>And now?</strong></p>
<p>We have the unpacked binary, we know where it is decrypted (but it seems that no key is used by the decryption function), so where is the key?</p>
<p>Now you can lose hours reversing other decryption functions or the fprintf function (as I did), but it is useless. :-)</p>
<p>The decryption function writes data up to 0x0042DDCA, so, let's see the memory at this location.</p>
<table>
<tbody>
<tr class="odd">
<td align="left"><img src="media/image8.png" width="600" height="308" /></td>
</tr>
<tr class="even">
<td align="left">There is a PE header!</td>
</tr>
</tbody>
</table>
<p>There is a PE header, if you want, you can see it using Ollydbg integrated PE header parser (you need to paste it inside a full PE header). This PE header is coherent (OEP, IAT, and IAT size) with the original executable we have found, so it is the original PE header of it.</p>
<p>Let's see if there are other PE headers (you can search for &quot;PE&quot; string).</p>
<p>At 0x00432046 there is another PE header, section names are: &quot;ddtek&quot;, &quot;rules&quot;, &quot;rsrc&quot; :-)</p>
<p>In my opinion, this means that the original executable file has been packed (at least) twice and this is the PE header of the intermediate step. According to this PE header OEP=0x00426000, IAT RVA=0x30014, IAT size=0x8F. If you want to analyze this intermediate step, you can place an hardware breakpoint on execution on 0x00426000</p>
<p>Searching for &quot;PE&quot; string you will find also this string (in the middle of hundreds of API names):</p>
<p>HowCanThisPossiblyBeAValidPEFile?</p>
<p>which is the solution!</p>
<p><strong>How I was suppose to know that?</strong></p>
<p>Solving this challenge can be very simple. You just need to run the program until it terminates, dump the memory and search the &quot;PE&quot; string inside the dump. (There is also an online tool that unpacks an executable file and extracts all the strings it founds [<a href="http://eureka.cyber-ta.org/"><em>http://eureka.cyber-ta.org</em></a>])</p>
<p>The problem is: how to know which is the string to look for?</p>
<p>Maybe you can notice that all APIs name are in reverse alphabetical order, except for the &quot;HowCanThisPossiblyBeAValidPEFile?&quot; string.</p>
<p>Another possibility is to realize that the program makes a lot of modifications inside PE header and it hides them from memory breakpoints using VirtualProtect API.</p>
<table>
<tbody>
<tr class="odd">
<td align="left"><img src="media/image9.png" width="600" height="228" /></td>
</tr>
<tr class="even">
<td align="left">b400 is removing memory breakpoints from PE header using VirtualProtect API.</td>
</tr>
</tbody>
</table>
<p>So you can understand that PE headers are, in some way, important for solving this challenge and you can have the idea of searching for the &quot;PE&quot; string.</p>




    </div>

    

<div class="article-tags">
  
  <a class="badge badge-light" href="/tags/ctf/">CTF</a>
  
</div>



    
      








  
  
    
  
  





  
  <div class="media author-card" itemscope itemtype="http://schema.org/Person">
    
      
      <img class="portrait mr-3" src="/authors/admin/avatar_hub703259d6dc6f66958479a17d975ab61_1965031_250x250_fill_lanczos_center_3.png" itemprop="image" alt="Avatar">
    

    <div class="media-body">
      <h5 class="card-title" itemprop="name"><a href="/authors/admin/">Antonio Bianchi</a></h5>
      <h6 class="card-subtitle">Associate Professor</h6>
      
      <ul class="network-icon" aria-hidden="true">
        
          
          
          
            
          
          
          
          
          
          <li>
            <a itemprop="sameAs" href="mailto:antoniob@purdue.edu" >
              <i class="fas fa-envelope"></i>
            </a>
          </li>
        
          
          
          
            
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://twitter.com/anton00b" target="_blank" rel="noopener">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
        
          
          
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="https://scholar.google.com/citations?user=RMm4j1AAAAAJ&amp;hl=en" target="_blank" rel="noopener">
              <i class="ai ai-google-scholar"></i>
            </a>
          </li>
        
          
          
          
          
          
          
          
            
          
          <li>
            <a itemprop="sameAs" href="/files/cv.pdf" >
              <i class="ai ai-cv"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>



      
      
    

    

    


  </div>
</article>

<div class="container">
  <footer class="site-footer">
  

  <p class="powered-by">
    

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

</div>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous"></script>
        
      

      
      
    

    
    

    
    
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script>
      const search_index_filename = "/index.json";
      const i18n = {
        'placeholder': "Search...",
        'results': "results found",
        'no_results': "No results found"
      };
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.eeb855c70a08cf40f8f8d58c82fa7d5e.js"></script>

  </body>
</html>

